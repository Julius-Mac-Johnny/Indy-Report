<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Request-Indy V8</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.4);
            --blur: 20px;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --primary: #007AFF;
            --danger: #FF3B30;
            --text: #1d1d1f;
            --text-secondary: #86868b;
            --radius: 20px;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: var(--font);
            overflow: hidden;
            background: #fbfbfd;
            color: var(--text);
        }

        /* MAP CONTAINER */
        #map { width: 100%; height: 100%; z-index: 1; }

        /* GLASSMORPHISM UTILS */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur));
            -webkit-backdrop-filter: blur(var(--blur));
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
        }

        /* TOP BAR */
        .top-bar {
            position: absolute;
            top: 50px; /* Safe area */
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            height: 50px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            z-index: 1000;
        }

        .icon-btn {
            background: none; border: none; padding: 10px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }
        .icon-btn:active { background: rgba(0,0,0,0.05); }
        .icon-btn svg { width: 20px; height: 20px; fill: var(--primary); }

        .search-input {
            flex: 1; border: none; background: transparent;
            font-size: 16px; margin: 0 10px; outline: none;
            color: var(--text);
        }

        /* BOTTOM SHEET */
        .bottom-sheet {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 400px; /* Max height */
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur));
            -webkit-backdrop-filter: blur(var(--blur));
            border-top-left-radius: 25px;
            border-top-right-radius: 25px;
            z-index: 1001;
            transform: translateY(280px); /* Initial minimized state */
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        }

        .drag-handle-area {
            width: 100%; height: 30px;
            display: flex; justify-content: center; align-items: center;
            cursor: grab;
            flex-shrink: 0;
        }
        
        .drag-pill {
            width: 40px; height: 5px; background: #c7c7cc; border-radius: 3px;
        }

        .sheet-content {
            padding: 0 20px 20px 20px;
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* ADDRESS CARDS */
        .info-header { font-size: 22px; font-weight: 700; margin-bottom: 2px; }
        .info-sub { font-size: 14px; color: var(--text-secondary); }
        .info-coords {
            font-family: monospace; font-size: 12px;
            background: rgba(0,0,0,0.05); padding: 5px 8px;
            border-radius: 6px; display: inline-block; margin-top: 5px;
        }

        /* BUTTONS */
        .action-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            margin-top: 10px;
        }
        
        .btn {
            background: var(--primary); color: white;
            border: none; padding: 12px; border-radius: 12px;
            font-size: 15px; font-weight: 600; cursor: pointer;
            text-align: center;
        }
        .btn.secondary { background: rgba(0,0,0,0.05); color: var(--primary); }
        
        /* SLIDER (Bureaucracy Fader) */
        .slider-container {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.03); padding: 10px; border-radius: 12px;
        }
        .slider-label { font-size: 12px; font-weight: 600; color: var(--text-secondary); }
        input[type=range] {
            width: 100px; /* Restrict width */
            accent-color: var(--primary);
        }

        /* TOAST */
        #toast {
            position: absolute; top: 110px; left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white;
            padding: 10px 20px; border-radius: 20px;
            font-size: 14px; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; z-index: 2000;
        }

        /* MENUS & LISTS */
        .menu-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 1002;
            display: none; justify-content: center; align-items: center;
        }
        .menu-card {
            width: 85%; max-width: 400px; background: #fff;
            border-radius: 20px; padding: 20px;
            max-height: 80%; overflow-y: auto;
        }
        .menu-title { font-size: 18px; font-weight: 700; margin-bottom: 15px; display:flex; justify-content:space-between; }
        .list-item {
            padding: 12px 0; border-bottom: 1px solid #eee;
            display: flex; flex-direction: column; gap: 5px;
        }
        .list-item:last-child { border-bottom: none; }
        .close-btn { background: none; border: none; font-size: 20px; color: var(--text-secondary); }

        .saved-note {
            border: 1px solid #ddd; padding: 5px; border-radius: 6px;
            font-size: 13px; width: 100%; font-family: inherit;
        }

        /* Map Style Switcher */
        .style-switcher { display: flex; gap: 10px; margin-bottom: 20px; }
        .style-opt { 
            flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 8px; 
            text-align: center; font-size: 12px; cursor: pointer; 
        }
        .style-opt.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* LOADING SPINNER */
        .loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 5000;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <div style="text-align:center">
            <div class="spinner"></div>
            <p style="margin-top:20px; font-weight:600;">Request-Indy V8</p>
            <p id="loading-text" style="font-size:12px; color:#888;">Initializing...</p>
        </div>
    </div>

    <div id="toast">Message</div>

    <div id="map"></div>

    <div class="top-bar glass">
        <button class="icon-btn" onclick="initLocate()" title="Find Me">
            <svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0 0 13 3.06V1h-2v2.06A8.994 8.994 0 0 0 3.06 11H1v2h2.06A8.994 8.994 0 0 0 11 20.94V23h2v-2.06A8.994 8.994 0 0 0 20.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
        </button>
        <input type="text" id="search-bar" class="search-input" placeholder="Search address..." onchange="handleSearch(this.value)">
        <button class="icon-btn" onclick="toggleMenu()">
            <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
        </button>
    </div>

    <div id="bottom-sheet" class="bottom-sheet">
        <div class="drag-handle-area" id="drag-handle">
            <div class="drag-pill"></div>
        </div>
        <div class="sheet-content">
            <div>
                <div id="addr-title" class="info-header">Searching...</div>
                <div id="addr-desc" class="info-sub">Tap anywhere on map</div>
                <div id="coords-display" class="info-coords">Waiting for GPS...</div>
            </div>

            <div class="slider-container">
                <span class="slider-label">Consumer</span>
                <input type="range" id="bureaucracy-slider" min="0" max="1" step="0.1" value="0" oninput="updateGridOpacity(this.value)">
                <span class="slider-label">Bureaucracy</span>
            </div>

            <div class="action-grid">
                <button class="btn" onclick="copySmartAddress()">Copy Address</button>
                <button class="btn secondary" onclick="savePoint()">Save Point</button>
                <button class="btn secondary" onclick="navigateExternal()">Nav (Maps)</button>
                <button class="btn secondary" onclick="clearMap()">Reset</button>
            </div>
        </div>
    </div>

    <div id="menu-overlay" class="menu-overlay" onclick="toggleMenu()">
        <div class="menu-card" onclick="event.stopPropagation()">
            <div class="menu-title">
                Settings & Saved
                <button class="close-btn" onclick="toggleMenu()">×</button>
            </div>
            
            <div style="margin-bottom:15px; font-weight:600; font-size:14px; color:#555;">Base Map Style</div>
            <div class="style-switcher">
                <div class="style-opt active" onclick="setBaseMap('voyager', this)">Clean</div>
                <div class="style-opt" onclick="setBaseMap('osm', this)">Std</div>
                <div class="style-opt" onclick="setBaseMap('esri', this)">Nav</div>
            </div>
            
            <button class="btn secondary" style="width:100%; margin-bottom:15px;" onclick="toggleSatellite()">Toggle Satellite View</button>

            <div style="border-bottom:2px solid #eee; margin-bottom:10px;"></div>
            <div style="font-weight:600; margin-bottom:10px;">Saved Points</div>
            <div id="saved-list">
                </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>

    <script>
        // --- CONFIG & STATE ---
        const INDY_LAT = 39.7684;
        const INDY_LNG = -86.1581;
        let map, baseLayers = {}, overlays = {};
        let currentMarker, tetherLine, refMarker;
        let currentData = {
            lat: 0, lng: 0,
            address: "Initializing...",
            context: "",
            isRef: false,
            refAddress: ""
        };
        let isSatellite = false;
        let activeBase = 'voyager';

        // Proj4 Definition: Indiana East State Plane (EPSG:2965)
        proj4.defs("EPSG:2965","+proj=tmerc +lat_0=37.5 +lon_0=-85.66666666666667 +k=0.9999666666666667 +x_0=100000 +y_0=250000 +ellps=GRS80 +datum=NAD83 +units=m +no_defs");

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                initMap();
                initLocate();
                loadSavedPoints();
                initDrag();
                
                // Hide loader
                setTimeout(() => {
                    document.getElementById('loading').style.opacity = '0';
                    setTimeout(() => document.getElementById('loading').style.display = 'none', 500);
                }, 1000);
            } catch (e) {
                document.getElementById('loading-text').innerText = "Error: " + e.message;
            }
        });

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([INDY_LAT, INDY_LNG], 13);
            L.control.zoom({ position: 'topright' }).addTo(map);

            // 1. Base Layers
            baseLayers.voyager = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OSM & Carto', maxZoom: 20
            }).addTo(map);

            baseLayers.osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19, attribution: '© OpenStreetMap'
            });

            baseLayers.esri = L.esri.basemapLayer('Streets');

            // Satellite Layer (Hidden by default)
            baseLayers.satellite = L.esri.basemapLayer('Imagery');

            // 2. IndyGIS Layers
            // Layer 18: Address Points (Always visible when zoomed in)
            overlays.addresses = L.esri.dynamicMapLayer({
                url: 'https://maps.indy.gov/arcgis/rest/services/MapIndy/MapIndyGeneral/MapServer',
                layers: [18],
                opacity: 1
            }).addTo(map);

            // Layer 16: The Grid (Bureaucracy Layer) - Starts Invisible
            overlays.grid = L.esri.dynamicMapLayer({
                url: 'https://maps.indy.gov/arcgis/rest/services/MapIndy/MapIndyGeneral/MapServer',
                layers: [16],
                opacity: 0 // Controlled by slider
            }).addTo(map);

            // Event Listeners
            map.on('click', (e) => handleMapClick(e.latlng));
        }

        // --- GPS LOGIC ---
        async function initLocate() {
            showToast("Locating...");
            
            const options = { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 };
            
            function onLocationFound(pos) {
                const { latitude, longitude } = pos.coords;
                handleMapClick({ lat: latitude, lng: longitude });
                map.flyTo([latitude, longitude], 18);
                showToast("Location Found");
            }

            function onLocationError(err) {
                console.warn("High Acc failed, trying low...", err);
                // Fallback to low accuracy
                navigator.geolocation.getCurrentPosition(
                    onLocationFound,
                    (e) => {
                         document.getElementById('addr-title').innerText = "Location Error";
                         document.getElementById('addr-desc').innerText = "Tap map to set manually";
                    },
                    { enableHighAccuracy: false, timeout: 10000 }
                );
            }

            try {
                if(!navigator.geolocation) throw new Error("No GPS");
                navigator.geolocation.getCurrentPosition(onLocationFound, onLocationError, options);
            } catch (e) {
                onLocationError(e);
            }
        }

        // --- GEOCODING & LOGIC ---
        async function handleMapClick(latlng) {
            // 1. Update Map UI
            if (currentMarker) map.removeLayer(currentMarker);
            if (tetherLine) map.removeLayer(tetherLine);
            if (refMarker) map.removeLayer(refMarker);

            currentMarker = L.marker(latlng).addTo(map).bindPopup("Exact Location").openPopup();
            
            // Convert to State Plane
            const [x, y] = proj4("EPSG:4326", "EPSG:2965", [latlng.lng, latlng.lat]);
            const coordsStr = `GPS: ${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)} | SP: ${x.toFixed(1)}, ${y.toFixed(1)}`;
            document.getElementById('coords-display').innerText = coordsStr;
            
            currentData.lat = latlng.lat;
            currentData.lng = latlng.lng;

            // 2. Fetch Address (Nominatim)
            // Header requirement for Nominatim
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latlng.lat}&lon=${latlng.lng}`;
            
            try {
                document.getElementById('addr-title').innerText = "Fetching address...";
                // Note: Direct fetch in browser usually sets User-Agent automatically, but we can't force headers easily in simple fetch due to CORS on some APIs. 
                // However, Nominatim usually accepts browser requests. If strictly needed we add header, but it might trigger CORS preflight fail on simple static sites.
                // We will attempt fetch without custom header first as browsers override 'User-Agent'.
                
                const res = await fetch(url);
                if (!res.ok) throw new Error("API Blocked");
                const data = await res.json();
                
                processAddressData(data, latlng);

            } catch (e) {
                console.error(e);
                document.getElementById('addr-title').innerText = "Connection Failed";
                document.getElementById('addr-desc').innerText = "Check internet connection";
            }
        }

        function processAddressData(data, clickLatLng) {
            const addr = data.address;
            const houseNum = addr.house_number;
            const road = addr.road || "Unnamed Road";
            
            // "Gov App Fix" Logic
            if (houseNum) {
                // Scenario A: Exact House
                currentData.address = `${houseNum} ${road}`;
                currentData.context = "";
                currentData.isRef = false;
                
                updateUI(currentData.address, "Exact Address");
            } else {
                // Scenario B: No House Number (Pothole/Empty Lot)
                // We assume the returned road is the nearest context. 
                // Finding exact nearest house_number coordinate requires complex overpass query.
                // We will simulate the visual "Tether" by keeping the click point and stating "Near..."
                
                currentData.address = `Near ${road}`;
                // Fallback: If city/postcode exists, append
                if(addr.postcode) currentData.address += `, ${addr.postcode}`;
                
                currentData.context = "(Approx Location)";
                currentData.isRef = true;
                
                updateUI(currentData.address, "Reference Address (Approx)");
                
                // Visual Tether: Since we don't have the specific lat/lng of the 'house' from simple reverse geocode,
                // we simulate the concept by drawing a dashed circle/line to the road center if possible, 
                // OR we just mark the clicked point visually as distinct.
                // For this implementation: We create a visual indicator that this is an approximation.
                
                L.circle(clickLatLng, {
                    color: 'red', fillColor: '#f03', fillOpacity: 0.2, radius: 20, dashArray: '5, 10'
                }).addTo(map);
            }
        }

        function updateUI(title, subtitle) {
            document.getElementById('addr-title').innerText = title;
            document.getElementById('addr-desc').innerText = subtitle;
            
            // Bring bottom sheet up if hidden
            const sheet = document.getElementById('bottom-sheet');
            if (sheet.getBoundingClientRect().top > window.innerHeight - 100) {
                 sheet.style.transform = 'translateY(0)'; // Show full
            }
            
            // Save to history
            saveHistory(title);
        }

        // --- BUREAUCRACY FADER ---
        function updateGridOpacity(val) {
            const opacity = parseFloat(val);
            // Grid max opacity is 0.6
            if (overlays.grid) overlays.grid.setOpacity(opacity * 0.6);
        }

        function setBaseMap(type, el) {
            if(isSatellite) return; // Don't switch if Sat mode is active
            
            // Reset Active UI
            document.querySelectorAll('.style-opt').forEach(d => d.classList.remove('active'));
            if(el) el.classList.add('active');
            
            activeBase = type;

            map.removeLayer(baseLayers.voyager);
            map.removeLayer(baseLayers.osm);
            map.removeLayer(baseLayers.esri);

            if (type === 'voyager') baseLayers.voyager.addTo(map);
            if (type === 'osm') baseLayers.osm.addTo(map);
            if (type === 'esri') baseLayers.esri.addTo(map);
        }

        function toggleSatellite() {
            isSatellite = !isSatellite;
            if (isSatellite) {
                map.addLayer(baseLayers.satellite);
                // Ensure overlays stay on top
                if(overlays.grid) overlays.grid.bringToFront();
                if(overlays.addresses) overlays.addresses.bringToFront();
            } else {
                map.removeLayer(baseLayers.satellite);
                setBaseMap(activeBase, null); // Restore base
            }
            toggleMenu(); // Close menu
        }

        // --- ACTIONS ---
        function copySmartAddress() {
            const sliderVal = document.getElementById('bureaucracy-slider').value;
            let textToCopy = "";

            if (sliderVal < 0.5) {
                // Clean Mode
                textToCopy = currentData.address;
            } else {
                // Grid Mode (Bureaucracy)
                const note = currentData.isRef ? " (Approx - Pothole/Issue at GPS)" : "";
                textToCopy = `${currentData.address}${note} | GPS: ${currentData.lat.toFixed(5)}, ${currentData.lng.toFixed(5)}`;
            }

            navigator.clipboard.writeText(textToCopy).then(() => {
                showToast("Copied to Clipboard!");
            }).catch(() => {
                showToast("Copy Failed");
            });
        }

        function navigateExternal() {
            // Sandbox safe navigation
            const url = `https://maps.apple.com/?q=${currentData.lat},${currentData.lng}`;
            window.location.href = url;
        }

        // --- DATA PERSISTENCE ---
        function savePoint() {
            const points = JSON.parse(localStorage.getItem('indy_saved') || '[]');
            const newPoint = {
                id: Date.now(),
                address: currentData.address,
                lat: currentData.lat,
                lng: currentData.lng,
                note: ""
            };
            points.push(newPoint);
            localStorage.setItem('indy_saved', JSON.stringify(points));
            showToast("Location Saved");
            loadSavedPoints();
        }

        function loadSavedPoints() {
            const list = document.getElementById('saved-list');
            list.innerHTML = '';
            const points = JSON.parse(localStorage.getItem('indy_saved') || '[]');

            points.forEach(p => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <strong>${p.address}</strong>
                        <button onclick="deletePoint(${p.id})" style="color:red;border:none;background:none;">Del</button>
                    </div>
                    <input class="saved-note" value="${p.note}" placeholder="Add notes..." onblur="updateNote(${p.id}, this.value)">
                `;
                div.onclick = (e) => {
                    if(e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
                        handleMapClick({ lat: p.lat, lng: p.lng });
                        toggleMenu();
                        map.setView([p.lat, p.lng], 18);
                    }
                };
                list.appendChild(div);
            });
        }

        function updateNote(id, text) {
            const points = JSON.parse(localStorage.getItem('indy_saved') || '[]');
            const idx = points.findIndex(p => p.id === id);
            if (idx > -1) {
                points[idx].note = text;
                localStorage.setItem('indy_saved', JSON.stringify(points));
            }
        }

        function deletePoint(id) {
            let points = JSON.parse(localStorage.getItem('indy_saved') || '[]');
            points = points.filter(p => p.id !== id);
            localStorage.setItem('indy_saved', JSON.stringify(points));
            loadSavedPoints();
        }

        function saveHistory(addr) {
            let hist = JSON.parse(localStorage.getItem('indy_history') || '[]');
            hist.unshift(addr);
            if(hist.length > 50) hist.pop();
            localStorage.setItem('indy_history', JSON.stringify(hist));
        }

        // --- UI INTERACTIONS ---
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 2500);
        }

        function toggleMenu() {
            const m = document.getElementById('menu-overlay');
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
        }

        function handleSearch(query) {
            if(!query) return;
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ' Indianapolis')}`;
            fetch(url).then(r => r.json()).then(data => {
                if(data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    handleMapClick({ lat: lat, lng: lon });
                    map.setView([lat, lon], 16);
                    document.getElementById('search-bar').blur();
                } else {
                    showToast("Address not found");
                }
            });
        }

        function clearMap() {
            if(currentMarker) map.removeLayer(currentMarker);
            document.getElementById('addr-title').innerText = "Ready";
            document.getElementById('addr-desc').innerText = "Tap map to begin";
            document.getElementById('coords-display').innerText = "";
            document.getElementById('search-bar').value = "";
        }

        // --- DRAG PHYSICS (Bottom Sheet) ---
        function initDrag() {
            const sheet = document.getElementById('bottom-sheet');
            const handle = document.getElementById('drag-handle');
            
            let startY = 0;
            let currentY = 0;
            let initialTransform = 0;
            // States: 'minimized' (280px down), 'expanded' (0px)
            let isExpanded = false; 

            handle.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
                const style = window.getComputedStyle(sheet);
                const matrix = new WebKitCSSMatrix(style.transform);
                initialTransform = matrix.m42;
                sheet.style.transition = 'none'; // Disable transition for direct drag
            });

            handle.addEventListener('touchmove', (e) => {
                currentY = e.touches[0].clientY;
                const delta = currentY - startY;
                let newPos = initialTransform + delta;
                
                // Limits
                if (newPos < 0) newPos = 0; // Top limit
                if (newPos > 350) newPos = 350; // Bottom limit
                
                sheet.style.transform = `translateY(${newPos}px)`;
            });

            handle.addEventListener('touchend', (e) => {
                sheet.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';
                const delta = currentY - startY;
                
                // Snap logic
                // If dragging up (delta negative)
                if (delta < -50) {
                    sheet.style.transform = 'translateY(0px)';
                    isExpanded = true;
                } 
                // If dragging down
                else if (delta > 50) {
                    sheet.style.transform = 'translateY(280px)';
                    isExpanded = false;
                }
                // Return to previous state if drag wasn't significant
                else {
                    sheet.style.transform = isExpanded ? 'translateY(0px)' : 'translateY(280px)';
                }
            });
            
            // Click to toggle
            handle.addEventListener('click', () => {
                 isExpanded = !isExpanded;
                 sheet.style.transform = isExpanded ? 'translateY(0px)' : 'translateY(280px)';
            });
        }
    </script>
</body>
</html>
