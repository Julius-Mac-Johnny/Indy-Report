<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Request-Indy V6</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>

    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --font: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            --bg: #F2F2F7;
            --card: rgba(255, 255, 255, 0.92);
            --blur: blur(25px);
            --text: #000000;
            --sub: #8E8E93;
            --blue: #007AFF;
            --red: #FF3B30;
            --green: #34C759;
            --radius: 18px;
            --shadow: 0 8px 32px rgba(0,0,0,0.12);
            --border: 0.5px solid rgba(0,0,0,0.15);
            --input: rgba(118, 118, 128, 0.12);
        }

        /* --- GLOBAL RESET --- */
        body, html { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; font-family: var(--font); background: var(--bg); -webkit-user-select: none; user-select: none; }
        
        /* --- MAP LAYER (Z:0) --- */
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 0; }

        /* --- UI LAYER (Z:1000) --- */
        .top-bar-container { position: absolute; top: 16px; left: 0; right: 0; display: flex; justify-content: center; pointer-events: none; z-index: 1000; }
        .top-bar { pointer-events: auto; background: var(--card); backdrop-filter: var(--blur); border: var(--border); box-shadow: var(--shadow); height: 50px; border-radius: 25px; display: flex; align-items: center; padding: 0 6px; gap: 8px; width: 92%; max-width: 600px; }
        
        .btn-blue { background: var(--blue); color: white; border: none; height: 36px; padding: 0 16px; border-radius: 18px; font-size: 13px; font-weight: 600; cursor: pointer; }
        
        .search-wrap { flex: 1; height: 36px; background: var(--input); border-radius: 10px; display: flex; align-items: center; padding: 0 8px; }
        #search-input { width: 100%; border: none; background: transparent; font-size: 16px; outline: none; }
        
        .icon-btn { background: transparent; border: none; font-size: 20px; width: 40px; cursor: pointer; color: var(--blue); }

        /* --- BOTTOM SHEET (Z:1000) --- */
        .bottom-sheet { position: absolute; bottom: 20px; left: 15px; right: 15px; background: var(--card); backdrop-filter: var(--blur); border: var(--border); border-radius: 24px; padding: 20px; box-shadow: var(--shadow); z-index: 1000; transition: transform 0.3s ease; }
        .bottom-sheet.minimized { transform: translateY(150%); }
        
        /* Drag Handle */
        .handle-row { display: flex; justify-content: center; margin-bottom: 15px; cursor: pointer; padding: 5px; }
        .handle { width: 40px; height: 5px; background: #C7C7CC; border-radius: 3px; }

        /* Info Display */
        .info-box { text-align: center; margin-bottom: 20px; }
        .label { font-size: 10px; font-weight: 700; color: var(--sub); text-transform: uppercase; letter-spacing: 0.5px; }
        .value { font-size: 17px; font-weight: 600; color: var(--text); }

        /* Buttons */
        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .btn { height: 46px; border: none; border-radius: 12px; font-weight: 600; font-size: 15px; cursor: pointer; width: 100%; }
        .btn-green { background: var(--green); color: white; }
        .btn-gray { background: var(--input); color: var(--text); }
        .btn-outline { background: transparent; border: 1px solid var(--sub); color: var(--text); font-size: 13px; }
        .btn-select { background: var(--input); color: var(--blue); margin-bottom: 12px; }

        /* Slider */
        .slider-row { background: var(--input); padding: 10px 15px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        input[type=range] { flex: 1; accent-color: var(--red); }
        .slider-txt { font-size: 11px; font-weight: 700; color: var(--sub); text-transform: uppercase; }

        /* --- MODALS (Z:2000) --- */
        .modal { position: absolute; top: 100px; left: 20px; right: 20px; max-width: 500px; margin: 0 auto; background: var(--card); backdrop-filter: var(--blur); border-radius: var(--radius); border: var(--border); box-shadow: var(--shadow); z-index: 2000; display: none; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 15px; background: rgba(0,0,0,0.03); border-bottom: var(--border); display: flex; justify-content: space-between; align-items: center; cursor: move; }
        .modal-title { margin: 0; font-size: 16px; font-weight: 700; }
        .modal-body { padding: 0; max-height: 50vh; overflow-y: auto; }
        
        /* List Items */
        .list-item { padding: 15px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .engine-item { padding: 15px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; font-weight: 600; }
        .engine-item.active { background: white; color: var(--blue); }

        /* --- TOAST --- */
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; font-weight: 600; z-index: 3000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .toast.show { opacity: 1; }

        /* --- AUTOCOMPLETE --- */
        #ac-list { position: absolute; top: 70px; left: 20px; right: 20px; max-width: 600px; margin: 0 auto; background: var(--card); backdrop-filter: var(--blur); border-radius: 12px; box-shadow: var(--shadow); display: none; z-index: 2500; }
        
        /* HIDE LEAFLET CONTROLS */
        .leaflet-control-attribution, .leaflet-control-zoom { display: none; }
    </style>
</head>
<body>

    <div id="toast" class="toast">Action Successful</div>

    <div class="top-bar-container">
        <div class="top-bar">
            <button class="btn-blue" onclick="locateUser()">Find Me</button>
            <div class="search-wrap">
                <input type="text" id="search-input" placeholder="Search..." oninput="handleTyping()">
            </div>
            <button class="icon-btn" onclick="toggleModal('menu-modal')">☰</button>
        </div>
    </div>

    <div id="ac-list"></div>

    <div id="map-modal" class="modal">
        <div class="modal-header" onmousedown="startDrag(event, 'map-modal')" ontouchstart="startDrag(event, 'map-modal')">
            <h3 class="modal-title">Select Map Style</h3>
            <button class="icon-btn" onclick="closeModals()">×</button>
        </div>
        <div class="modal-body" id="engine-list"></div>
    </div>

    <div id="menu-modal" class="modal">
        <div class="modal-header" onmousedown="startDrag(event, 'menu-modal')" ontouchstart="startDrag(event, 'menu-modal')">
            <h3 class="modal-title">Menu</h3>
            <button class="icon-btn" onclick="closeModals()">×</button>
        </div>
        <div class="modal-body" style="padding:15px">
            <button class="btn btn-select" onclick="openSaved()">Saved Points</button>
            <button class="btn btn-select" onclick="openHistory()">History</button>
            <button class="btn btn-select" onclick="openErrors()">Error Logs</button>
        </div>
    </div>

    <div id="generic-modal" class="modal">
        <div class="modal-header" onmousedown="startDrag(event, 'generic-modal')" ontouchstart="startDrag(event, 'generic-modal')">
            <h3 class="modal-title" id="modal-title">List</h3>
            <button class="icon-btn" onclick="closeModals()">×</button>
        </div>
        <div class="modal-body" id="modal-content"></div>
        <div style="padding:10px">
            <button class="btn btn-gray" onclick="copyList()">Copy List</button>
        </div>
    </div>

    <div id="map"></div>

    <div class="bottom-sheet" id="dock">
        <div class="handle-row" onclick="toggleDock()"><div class="handle"></div></div>
        
        <div class="info-box">
            <span class="label" id="data-label">Standard Address</span>
            <div class="value" id="data-val">Tap map to select...</div>
        </div>

        <button class="btn btn-select" onclick="openMapSelect()">Select Map Engine ▾</button>

        <div class="btn-row">
            <button class="btn btn-green" onclick="savePoint()">Save Point</button>
            <button class="btn btn-gray" onclick="smartCopy()">Copy Data</button>
        </div>

        <div class="btn-row" style="grid-template-columns: 1fr 1fr 1fr;">
            <button class="btn btn-outline" onclick="openLink('apple')">Apple</button>
            <button class="btn btn-outline" onclick="openLink('google')">Google</button>
            <button class="btn btn-outline" onclick="openLink('street')">Street</button>
        </div>

        <div class="slider-row">
            <span class="slider-txt">Clean</span>
            <input type="range" min="0" max="1" step="0.1" value="0" id="opacitySlider">
            <span class="slider-txt" style="color:var(--red)">Grid</span>
        </div>
    </div>

<script>
    // --- 1. SAFE STARTUP (Anti-Crash) ---
    const state = {
        lat: 0, lng: 0, address: "Unknown", cityCoords: "Pending",
        saved: [], history: [], errors: [],
        mapStyle: 'voyager'
    };

    // Try to load data, but wipe if corrupt
    try {
        state.saved = JSON.parse(localStorage.getItem('ri_saved')) || [];
        state.history = JSON.parse(localStorage.getItem('ri_history')) || [];
    } catch(e) {
        console.error("Data Corrupt, Resetting");
        localStorage.clear();
    }

    // --- 2. MAP ENGINES ---
    const engines = {
        voyager: { name: "Carto Voyager (Clean)", url: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png' },
        osm: { name: "OpenStreetMap (Standard)", url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png' },
        esri: { name: "Esri World Street", url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}' },
        sat: { name: "Esri Satellite", url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}' }
    };

    // --- 3. INIT MAP ---
    const map = L.map('map', { zoomControl: false, tap: true }).setView([39.7684, -86.1581], 15);
    let baseLayer = L.tileLayer(engines.voyager.url, { maxZoom: 19 }).addTo(map);

    // City Layers
    const cityUrl = 'https://xmaps.indy.gov/arcgis/rest/services/SalesForce/MAC311/MapServer';
    // Addresses (Layer 18) - Always Visible
    L.esri.dynamicMapLayer({url: cityUrl, layers: [18], opacity: 0.9, f: 'json'}).addTo(map);
    // Grid (Layer 16) - Controlled by Slider
    const gridLayer = L.esri.dynamicMapLayer({url: cityUrl, layers: [16], opacity: 0, f: 'json'}).addTo(map);

    // --- 4. CORE LOGIC ---
    // Proj4 Definition
    if(window.proj4) proj4.defs("EPSG:2965", "+proj=tmerc +lat_0=37.5 +lon_0=-85.66666666666667 +k=0.9999666666666667 +x_0=2960000 +y_0=250000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=us-ft +no_defs");

    map.on('click', (e) => {
        state.lat = e.latlng.lat;
        state.lng = e.latlng.lng;
        
        // Marker
        map.eachLayer(layer => { if(layer instanceof L.Marker) map.removeLayer(layer); });
        L.marker([state.lat, state.lng]).addTo(map);

        // Calculate City Coords
        if(window.proj4) {
            try {
                const p = proj4("EPSG:4326", "EPSG:2965", [state.lng, state.lat]);
                state.cityCoords = `X: ${Math.round(p[0])}, Y: ${Math.round(p[1])}`;
            } catch(err) { state.cityCoords = "Error"; }
        }

        // Fetch Address
        document.getElementById('data-val').innerText = "Loading...";
        fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${state.lat}&lon=${state.lng}`, {
            headers: { 'User-Agent': 'Request-Indy-App' }
        })
        .then(r => r.json())
        .then(d => {
            const num = d.address.house_number || "";
            const road = d.address.road || "Unnamed";
            const name = d.name ? d.name + ", " : "";
            state.address = name + num + " " + road;
            updateUI();
            saveHistory();
        })
        .catch(e => {
            state.address = "Unknown Location";
            logError("Geocode Failed");
            updateUI();
        });
    });

    function updateUI() {
        const isGrid = document.getElementById('opacitySlider').value > 0.1;
        const lbl = document.getElementById('data-label');
        const val = document.getElementById('data-val');

        if(isGrid) {
            lbl.innerText = "OFFICIAL CITY COORDINATES";
            lbl.style.color = "var(--red)";
            val.innerText = state.cityCoords;
        } else {
            lbl.innerText = "STANDARD ADDRESS";
            lbl.style.color = "var(--sub)";
            val.innerText = state.address;
        }
    }

    // --- 5. INTERACTION ---
    document.getElementById('opacitySlider').addEventListener('input', (e) => {
        gridLayer.setOpacity(e.target.value);
        updateUI();
    });

    function locateUser() {
        showToast("Locating...");
        map.locate({setView: true, maxZoom: 18, timeout: 8000});
    }
    map.on('locationfound', (e) => { map.fireEvent('click', {latlng: e.latlng}); showToast("Found You"); });
    map.on('locationerror', () => { showToast("GPS Failed - Retrying Low Acc"); map.locate({setView:true, enableHighAccuracy:false}); });

    // --- 6. MODAL SYSTEM ---
    function closeModals() {
        document.querySelectorAll('.modal').forEach(el => el.style.display = 'none');
        document.getElementById('ac-list').style.display = 'none';
    }
    
    function openMapSelect() {
        closeModals();
        const list = document.getElementById('engine-list');
        list.innerHTML = '';
        Object.keys(engines).forEach(key => {
            const div = document.createElement('div');
            div.className = `engine-item ${state.mapStyle === key ? 'active' : ''}`;
            div.innerText = engines[key].name;
            div.onclick = () => {
                map.removeLayer(baseLayer);
                baseLayer = L.tileLayer(engines[key].url, {maxZoom: 19}).addTo(map);
                baseLayer.bringToBack();
                state.mapStyle = key;
                closeModals();
            };
            list.appendChild(div);
        });
        document.getElementById('map-modal').style.display = 'flex';
    }

    function openSaved() { renderGenericList("Saved Points", state.saved); }
    function openHistory() { renderGenericList("History", state.history); }
    function openErrors() { renderGenericList("Error Logs", state.errors); }

    function renderGenericList(title, dataArray) {
        closeModals();
        document.getElementById('modal-title').innerText = title;
        const content = document.getElementById('modal-content');
        content.innerHTML = '';
        
        dataArray.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = 'list-item';
            // Handle simple strings (errors) or objects (saved/history)
            const text = typeof item === 'string' ? item : (item.addr || item.desc);
            const sub = typeof item === 'string' ? '' : (item.coords || item.date);
            
            div.innerHTML = `
                <div><strong>${text}</strong><br><small style="color:#888">${sub}</small></div>
                ${title === 'Saved Points' ? `<button style="color:red;border:none;background:none" onclick="deleteSaved(${i})">✕</button>` : ''}
            `;
            content.appendChild(div);
        });
        
        document.getElementById('generic-modal').style.display = 'flex';
    }

    function deleteSaved(i) {
        state.saved.splice(i, 1);
        localStorage.setItem('ri_saved', JSON.stringify(state.saved));
        openSaved(); // Re-render
    }

    function savePoint() {
        if(!state.address) return showToast("Select location first");
        state.saved.push({addr: state.address, coords: state.cityCoords});
        localStorage.setItem('ri_saved', JSON.stringify(state.saved));
        showToast("Location Saved!");
    }

    function saveHistory() {
        state.history.unshift({addr: state.address, date: new Date().toLocaleTimeString()});
        if(state.history.length > 50) state.history.pop();
        localStorage.setItem('ri_history', JSON.stringify(state.history));
    }

    // --- 7. DRAG LOGIC (UNLOCKED) ---
    let dragObj = null;
    let offset = {x:0, y:0};

    window.startDrag = function(e, id) {
        // PREVENT TEXT HIGHLIGHT
        e.preventDefault(); 
        
        dragObj = document.getElementById(id);
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        
        const rect = dragObj.getBoundingClientRect();
        offset.x = clientX - rect.left;
        offset.y = clientY - rect.top;

        document.addEventListener('mousemove', doDrag);
        document.addEventListener('touchmove', doDrag, {passive: false});
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);
    };

    function doDrag(e) {
        if(!dragObj) return;
        e.preventDefault();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        
        dragObj.style.left = (clientX - offset.x) + 'px';
        dragObj.style.top = (clientY - offset.y) + 'px';
    }

    function stopDrag() {
        dragObj = null;
        document.removeEventListener('mousemove', doDrag);
        document.removeEventListener('touchmove', doDrag);
    }

    // --- 8. UTILS ---
    function toggleDock() { document.getElementById('dock').classList.toggle('minimized'); }
    
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    function smartCopy() {
        const txt = document.getElementById('data-val').innerText;
        navigator.clipboard.writeText(txt).then(() => showToast("Copied!"));
    }

    function logError(msg) {
        state.errors.push(new Date().toLocaleTimeString() + ": " + msg);
    }

    function openLink(type) {
        if(!state.lat) return showToast("Select location first");
        let url = "";
        if(type === 'google') url = `https://www.google.com/maps/search/?api=1&query=${state.lat},${state.lng}`;
        if(type === 'apple') url = `http://maps.apple.com/?q=${state.lat},${state.lng}`;
        if(type === 'street') url = `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${state.lat},${state.lng}`;
        window.location.href = url;
    }

    // --- 9. AUTOCOMPLETE ---
    let timer;
    function handleTyping() {
        clearTimeout(timer);
        const q = document.getElementById('search-input').value;
        if(q.length < 3) return;
        timer = setTimeout(() => {
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}, Indianapolis`)
            .then(r=>r.json()).then(d => {
                const list = document.getElementById('ac-list');
                list.innerHTML = '';
                list.style.display = 'block';
                d.forEach(i => {
                    const div = document.createElement('div');
                    div.className = 'engine-item';
                    div.innerText = i.display_name.split(',')[0];
                    div.onclick = () => {
                        map.setView([i.lat, i.lon], 18);
                        map.fireEvent('click', {latlng: {lat: i.lat, lng: i.lon}});
                        list.style.display = 'none';
                    };
                    list.appendChild(div);
                });
            });
        }, 500);
    }

    // FORCE RENDER LISTS ON LOAD
    openMapSelect(); // Pre-build map list
    closeModals();   // Then hide it
</script>
</body>
</html>
